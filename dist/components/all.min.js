"use strict";angular.module("cossap.cesiumpanel",[]).controller("CesiumPanelController",["$scope","cossapChartState",function(e,t){e.cossapChartState=t}]),angular.module("cossap.catalogue",[]).directive("cossapCatalogue",[function(){return{templateUrl:"components/catalogue/catalogue.html",controller:"cossapCatalogueController"}}]).controller("cossapCatalogueController",["$scope","streamChartService","drawHelperService","pickService","miniMapService",function(e,t,a,r,n){e.drawHelperService=a;var i,o,l,s,c,u=_viewer.scene.imageryLayers;e.drawHelperService.init(_viewer),e.pickService=r;var d=function(e){console.log("myDrawCallback"),console.log(e)};e.initDrawTools=function(){e.drawHelperService.active=!0},e.callDrawMarker=function(){var t={callback:d,imgUrl:"bower_components/cesium-ng-drawhelper/img/dragIcon.png"};e.drawHelperService.drawMarker(t)},e.callDrawLine=function(){var t={callback:d,editable:!0,width:5,geodesic:!0};e.drawHelperService.drawPolyline(t)},e.callDrawPoly=function(){var t={callback:d,editable:!0};e.drawHelperService.drawPolygon(t)},e.callDrawExtent=function(){var t={callback:d,editable:!0};e.drawHelperService.drawExtent(t)},e.callDrawCircle=function(){var t={callback:d,editable:!0};e.drawHelperService.drawCircle(t)},e.demoGraph=function(){t.initChart()},e.demoPoly=function(){_viewer.entities.add({name:"Orange polygon with per-position heights and outline",polygon:{hierarchy:Cesium.Cartesian3.fromDegreesArrayHeights([138,-25,1e5,130,-25,1e5,130,-20,1e5,138,-20,3e5]),extrudedHeight:0,perPositionHeight:!0,material:Cesium.Color.ORANGE.withAlpha(.5),outline:!0,outlineColor:Cesium.Color.BLACK}});_viewer.zoomTo(_viewer.entities)},e.destroyCursorHandler=function(){i&&(i.destroy(),i=null)},e.addCursorHandler=function(){var e=_viewer.scene.globe.ellipsoid,t=_viewer.entities.add({label:{show:!1}});i=new Cesium.ScreenSpaceEventHandler(_viewer.scene.canvas),i.setInputAction(function(a){var r=_viewer.camera.pickEllipsoid(a.endPosition,e);if(r){var n=e.cartesianToCartographic(r),i=Cesium.Math.toDegrees(n.longitude).toFixed(2),o=Cesium.Math.toDegrees(n.latitude).toFixed(2);t.position=r,t.label.show=!0,t.label.text="("+i+", "+o+")"}else t.label.show=!1},Cesium.ScreenSpaceEventType.MOUSE_MOVE)},e.addPickListener=function(){r.addPickListener()},e.rest=function(){console.log("ArcGis");var e="http://www.ga.gov.au/gis/rest/services/topography/Australian_Topography_WM/MapServer",t="0";return s?(u.remove(s),console.log("removing layer.."),void(s=null)):void(s=u.addImageryProvider(new Cesium.ArcGisMapServerImageryProvider({url:e,layers:t,rectangle:ausExtent})))},e.wms=function(){if(console.log("wms"),o)return u.remove(o),console.log("removing layer.."),void(o=null);var e="https://programs.communications.gov.au/geoserver/ows",t="mybroadband:MyBroadband_ADSL_Availability";o=u.addImageryProvider(new Cesium.WebMapServiceImageryProvider({url:e,layers:t,rectangle:ausExtent,parameters:{transparent:"true",format:"image/png"},enablePickFeatures:!0})),o.alpha=.6,console.log(_viewer.scene.imageryLayers)},e.wmsProxy=function(){if(console.log("text proxy"),l)return u.remove(l),console.log("removing layer.."),void(l=null);var e="http://localhost:9090/geoserver/cossap/wms?service=WMS",t="cossap:Acreage_AcreageReleaseAreas_2014";l=u.addImageryProvider(new Cesium.WebMapServiceImageryProvider({url:e,layers:t,rectangle:ausExtent,parameters:{transparent:"true",format:"image/png",proxy:{getURL:function(e){return"/proxy/url?url="+encodeURIComponent(e)}}},enablePickFeatures:!0})),l.alpha=.6,console.log(_viewer.scene.imageryLayers)},e.boreholes=function(){if(console.log("boreholes"),c)return u.remove(c),console.log("removing layer.."),void(c=null);var e="http://www.ga.gov.au/borehole-gsmlborehole-gws/ows",t="gsmlp:BoreholeView",a=function(){console.log("CALLBACK.. only fires when no features returned...")};c=u.addImageryProvider(new Cesium.WebMapServiceImageryProvider({url:e,layers:t,rectangle:ausExtent,parameters:{transparent:"true",format:"image/png"},enablePickFeatures:!0,getFeatureInfoFormats:[new Cesium.GetFeatureInfoFormat("json","application/json",a)]})),c.alpha=1},e.demoMiniMap=function(){var e="http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer",t="0",a=new Cesium.ArcGisMapServerImageryProvider({url:e,layers:t,rectangle:ausExtent});n.init(_viewer,a)}}]),angular.module("cossap.charts.stream",[]).directive("chartStream",[function(){return{templateUrl:"components/charts/chart-stream.html",controller:"streamChartController"}}]).controller("streamChartController",["$scope","cossapChartState",function(e,t){e.cossapChartState=t}]).factory("streamChartService",["$rootScope","cossapChartState",function(e,t){var a={};return a.initChart=function(){if(console.log("initChart.."),t.chartPanel)return t.chartPanel=!1,void $("#streamChartD3").html("");t.chartPanel=!0;var a={top:0,right:100,bottom:30,left:100},r=1e3,n=320-a.top-a.bottom,i=d3.scale.ordinal().rangeRoundBands([0,r],.1),o=d3.scale.linear().rangeRound([n,0]),l=d3.svg.axis().scale(i).orient("bottom"),s=d3.svg.axis().scale(o).orient("left"),c=d3.layout.stack().offset("wiggle").values(function(e){return e.values}).x(function(e){return i(e.label)+i.rangeBand()/2}).y(function(e){return e.value}),u=d3.svg.area().interpolate("cardinal").x(function(e){return i(e.label)+i.rangeBand()/2}).y0(function(e){return o(e.y0)}).y1(function(e){return o(e.y0+e.y)}),d=d3.scale.ordinal().range(["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3"]),g=d3.select("#streamChartD3").append("svg").attr("width",r+a.left+a.right).attr("height",n+a.top+a.bottom).append("g").attr("transform","translate("+a.left+","+a.top+")");d3.csv("components/charts/demo.csv",function(e,t){function a(){$(".popover").each(function(){$(this).remove()})}function m(e){$(this).popover({title:e.name,placement:"auto top",container:"body",trigger:"manual",html:!0,content:function(){return"Quarter: "+e.label+"<br/>Rounds: "+d3.format(",")(e.value?e.value:e.y1-e.y0)}}),$(this).popover("show")}console.log(t);var p="quarter",v=d3.keys(t[0]).filter(function(e){return e!==p});d.domain(v);var h=[],w={};v.forEach(function(e){w[e]={name:e,values:[]},h.push(w[e])}),t.forEach(function(e){v.map(function(t){w[t].values.push({name:t,label:e[p],value:+e[t]})})}),i.domain(t.map(function(e){return e.quarter})),c(h),o.domain([0,d3.max(h,function(e){return d3.max(e.values,function(e){return e.y0+e.y})})]),g.append("g").attr("class","x axis").attr("transform","translate(0,"+n+")").call(l),g.append("g").attr("class","y axis").call(s).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").style("fill","#FFF").text("Number of Rounds");var C=g.selectAll(".series").data(h).enter().append("g").attr("class","series");C.append("path").attr("class","streamPath").attr("d",function(e){return u(e.values)}).style("fill",function(e){return d(e.name)}).style("stroke","grey");var f=g.selectAll(".seriesPoints").data(h).enter().append("g").attr("class","seriesPoints");f.selectAll(".point").data(function(e){return e.values}).enter().append("circle").attr("class","point").attr("cx",function(e){return i(e.label)+i.rangeBand()/2}).attr("cy",function(e){return o(e.y0+e.y)}).attr("r","10px").style("fill",function(e){return d(e.name)}).on("mouseover",function(e){m.call(this,e)}).on("mouseout",function(e){a()});var y=g.selectAll(".legend").data(v.slice().reverse()).enter().append("g").attr("class","legend").attr("transform",function(e,t){return"translate(55,"+20*t+")"});y.append("rect").attr("x",r-10).attr("width",10).attr("height",10).style("fill",d).style("stroke","grey"),y.append("text").attr("x",r-12).attr("y",6).attr("dy",".35em").style("text-anchor","end").style("fill","#FFF").text(function(e){return e})}),e.$$phase||e.$apply()},a}]),angular.module("cossap.charts",[]).directive("cossapChartPanel",[function(){return{templateUrl:"components/charts/charts.html",controller:"cossapChartController"}}]).controller("cossapChartController",["$scope","cossapChartState",function(e,t){e.cossapChartState=t}]).factory("cossapChartState",[function(){var e={};return e.chartPanel=!1,e.streamChart=!1,e}]),angular.module("cesium.drawhelper",[]).factory("drawHelperService",[function(){var e={};e.active=!1,e.drawHelper,e.scene,e.loggingMessage;var t=Cesium.Material.fromType(Cesium.Material.ColorType);t.uniforms.color=new Cesium.Color(0,0,153,.4);var a=new Cesium.PrimitiveCollection,r=new Cesium.BillboardCollection;return e.init=function(t){e.scene=t.scene,a.add(r),e.scene.primitives.add(a),e.drawHelper=new DrawHelper(t);var n=document.getElementById("logging");e.loggingMessage=function(e){n.innerHTML=e}},e.drawMarker=function(t){e.active=!0,e.drawHelper.startDrawingMarker({callback:function(a){e.loggingMessage("Marker created at "+a.toString());var n=r.add({show:!0,position:a,pixelOffset:new Cesium.Cartesian2(0,0),eyeOffset:new Cesium.Cartesian3(0,0,0),horizontalOrigin:Cesium.HorizontalOrigin.CENTER,verticalOrigin:Cesium.VerticalOrigin.CENTER,scale:1,image:t.imgUrl,color:new Cesium.Color(1,1,1,1)});n.setEditable(),t.hasOwnProperty("callback")?t.callback(n):console.log(n)}})},e.drawPolyline=function(t){e.active=!0,e.drawHelper.startDrawingPolyline({callback:function(r){e.loggingMessage("Polyline created with "+r.length+" points");var n=new DrawHelper.PolylinePrimitive({positions:r,width:t.width||5,geodesic:t.hasOwnProperty("geodesic")?t.geodesic:!0});a.add(n),t.hasOwnProperty("editable")&&t.editable&&(n.setEditable(),n.addListener("onEdited",function(t){e.loggingMessage("Polyline edited, "+t.positions.length+" points")})),t.hasOwnProperty("callback")?t.callback(n):console.log(n)}})},e.drawPolygon=function(r){e.active=!0,e.drawHelper.startDrawingPolygon({callback:function(n){e.loggingMessage("Polygon created with "+n.length+" points");var i=new DrawHelper.PolygonPrimitive({positions:n,material:t});a.add(i),r.hasOwnProperty("editable")&&r.editable&&(i.setEditable(),i.addListener("onEdited",function(t){console.log(t),e.loggingMessage("Polygon edited, "+t.positions.length+" points")})),r.hasOwnProperty("callback")?r.callback(i):console.log(i)}})},e.drawExtent=function(r){e.active=!0,e.drawHelper.startDrawingExtent({callback:function(n){e.loggingMessage("Extent created (N: "+n.north.toFixed(3)+", E: "+n.east.toFixed(3)+", S: "+n.south.toFixed(3)+", W: "+n.west.toFixed(3)+")");var i=new DrawHelper.ExtentPrimitive({extent:n,material:t});a.add(i),r.hasOwnProperty("editable")&&r.editable&&(i.setEditable(),i.addListener("onEdited",function(t){e.loggingMessage("Extent edited: extent is (N: "+t.extent.north.toFixed(3)+", E: "+t.extent.east.toFixed(3)+", S: "+t.extent.south.toFixed(3)+", W: "+t.extent.west.toFixed(3)+")")})),r.hasOwnProperty("callback")?r.callback(i):console.log(i)}})},e.drawCircle=function(r){e.active=!0,e.drawHelper.startDrawingCircle({callback:function(n,i){e.loggingMessage("Circle created: center is "+n.toString()+" and radius is "+i.toFixed(1)+" meters");var o=new DrawHelper.CirclePrimitive({center:n,radius:i,material:t});a.add(o),r.hasOwnProperty("editable")&&r.editable&&(o.setEditable(),o.addListener("onEdited",function(t){e.loggingMessage("Circle edited: radius is "+t.radius.toFixed(1)+" meters")})),r.hasOwnProperty("callback")?r.callback(o):console.log(o)}})},e.removeAllPrimitives=function(){a.removeAll(),a=new Cesium.PrimitiveCollection,r=new Cesium.BillboardCollection,a.add(r),e.scene.primitives.add(a)},e.getDisplayLatLngString=function(e,t){return Cesium.Math.toDegrees(e.longitude).toFixed(2)+", "+Cesium.Math.toDegrees(e.latitude).toFixed(2)},e}]),angular.module("cesium.picker",[]).factory("pickService",["$q",function(e){var t,a={};return a.destroyPickListener=function(){t.destroy()},a.addPickListener=function(){var e=_viewer.scene.globe.ellipsoid,r=_viewer.entities.add({label:{show:!1}});t=new Cesium.ScreenSpaceEventHandler(_viewer.scene.canvas),t.setInputAction(function(t){var n=_viewer.camera.pickEllipsoid(t.position,e);if(n){var i=e.cartesianToCartographic(n),o=Cesium.Math.toDegrees(i.longitude).toFixed(2),l=Cesium.Math.toDegrees(i.latitude).toFixed(2);r.position=n,r.label.show=!0,r.label.text="("+o+", "+l+")",a.pickImageryFeatures(t.position)}else r.label.show=!1},Cesium.ScreenSpaceEventType.LEFT_CLICK)},a.pickImageryFeatures=function(t){var a=e.defer(),r=_viewer.scene.camera.getPickRay(t),n=_viewer.scene.imageryLayers.pickImageryLayerFeatures(r,_viewer.scene);return Cesium.defined(n)?Cesium.when(n,function(e){console.log(e),a.resolve(e)}):console.log("No features picked."),a.promise},a}]),angular.module("cesium.minimap",[]).factory("miniMapService",[function(){function e(){var e=document.createElement("div");return e.className="cesium-minimap",g.parentViewer.bottomContainer.appendChild(e),e}function t(e){g.options.creditContainer=document.createElement("div");var t=new Cesium.Viewer(e,g.options);t.scene.imageryLayers.removeAll();var a=t.scene;a.screenSpaceCameraController.enableRotate=!1,a.screenSpaceCameraController.enableTranslate=!1,a.screenSpaceCameraController.enableZoom=!1,a.screenSpaceCameraController.enableTilt=!1,a.screenSpaceCameraController.enableLook=!1,g.miniViewer=t}function a(){g.intervalHandle=setInterval(function(){var e=parseFloat(Cesium.Math.toDegrees(g.parentCamera.heading));console.log("degrees: "+(360-e));var t=l(50);n(g.miniViewer,t.rectangle,e);var a=s(300).rectangle;g.miniViewer.scene.camera.viewRectangle(a)},10)}function r(){clearInterval(g.intervalHandle),console.log("stopped")}function n(e,t,a){var r=e.entities;r.removeAll(),r.add({rectangle:{coordinates:t,outline:!0,outlineColor:Cesium.Color.RED,outlineWidth:4,material:Cesium.Color.RED.withAlpha(0)}})}function i(e){var t=window.devicePixelRatio||1,a=Cesium.Ellipsoid.WGS84,r=new Cesium.Cartesian2(-e,-e),n=g.parentViewer.scene.camera.pickEllipsoid(r,a),r=new Cesium.Cartesian2(g.parentViewer.scene.canvas.width/t+e,-e),i=g.parentViewer.scene.camera.pickEllipsoid(r,a);r=new Cesium.Cartesian2(-e,g.parentViewer.scene.canvas.height/t+e);var o=g.parentViewer.scene.camera.pickEllipsoid(r,a);r=new Cesium.Cartesian2(g.parentViewer.scene.canvas.width/t+e,g.parentViewer.scene.canvas.height/t+e);var l=g.parentViewer.scene.camera.pickEllipsoid(r,a);return[a.cartesianToCartographic(n),a.cartesianToCartographic(o),a.cartesianToCartographic(l),a.cartesianToCartographic(i)]}function o(e,t){var a,r=Math.abs(parseInt(e/90));console.log("index "+r);var n=[[0,1,2,3],[3,0,1,2],[2,3,0,1],[1,2,3,0]];a=new Cesium.Rectangle.fromDegrees(Cesium.Math.toDegrees(t[n[r][0]].longitude),Cesium.Math.toDegrees(t[n[r][1]].latitude),Cesium.Math.toDegrees(t[n[r][2]].longitude),Cesium.Math.toDegrees(t[n[r][3]].latitude));var i={xmin:Cesium.Math.toDegrees(t[n[r][0]].longitude),ymin:Cesium.Math.toDegrees(t[n[r][1]].latitude),xmax:Cesium.Math.toDegrees(t[n[r][2]].longitude),ymax:Cesium.Math.toDegrees(t[n[r][3]].latitude)};return{rectangle:a,extent:i}}function l(e){var t=i(e);console.log(t);var a=parseFloat(Cesium.Math.toDegrees(g.parentCamera.heading)),r=360-a;return o(r,t)}function s(e){var t=Cesium.Ellipsoid.WGS84,a=window.devicePixelRatio||1,r=new Cesium.Cartesian2(-e,-e),n=g.parentViewer.scene.camera.pickEllipsoid(r,t);r=new Cesium.Cartesian2(g.parentViewer.scene.canvas.width/a+e,g.parentViewer.scene.canvas.height/a+e);var i=g.parentViewer.scene.camera.pickEllipsoid(r,t);if(null!=n&&null!=i){n=t.cartesianToCartographic(n),i=t.cartesianToCartographic(i);var o=new Cesium.Rectangle.fromDegrees(Cesium.Math.toDegrees(n.longitude),Cesium.Math.toDegrees(i.latitude),Cesium.Math.toDegrees(i.longitude),Cesium.Math.toDegrees(n.latitude)),l={xmin:Cesium.Math.toDegrees(n.longitude),ymin:Cesium.Math.toDegrees(i.latitude),xmax:Cesium.Math.toDegrees(i.longitude),ymax:Cesium.Math.toDegrees(n.latitude)};return g.logging.style.display="none",{rectangle:o,extent:l}}return c(),null}function c(){console.log("the sky is falling"),g.miniViewer.camera.viewRectangle(ausExtent),g.logging.style.display="block"}function u(){g.parentViewer.scene.camera.moveStart.addEventListener(a),g.parentViewer.scene.camera.moveEnd.addEventListener(r)}function d(){var e=document.createElement("a");e.className="minimap-toggle-display";var t=document.createElement("i");return t.className="fa fa-arrow-right",e.appendChild(t),e.onclick=function(e){return e.preventDefault(),g.toggle(),!1},e}var g={};return g.parentViewer,g.parentCamera,g.expanded=!0,g.miniViewer,g.container,g.toggleButton,g.logging,g.options={animation:!1,baseLayerPicker:!1,fullscreenButton:!1,geocoder:!1,homeButton:!1,infoBox:!1,sceneModePicker:!1,selectionIndicator:!1,timeline:!1,navigationHelpButton:!1,navigationInstructionsInitiallyVisible:!1,orderIndependentTranslucency:!1,sceneMode:Cesium.SceneMode.SCENE2D,mapProjection:new Cesium.WebMercatorProjection},g.init=function(a,r){g.parentViewer=a,g.parentCamera=g.parentViewer.scene.camera;var n=document.createElement("div");n.className="minimap-container",g.logging=document.createElement("div"),g.logging.innerHTML="Using National Scale",g.logging.className="minimap-logging",n.appendChild(g.logging),g.container=e(),g.container.appendChild(n),g.toggleButton=d(),g.container.appendChild(g.toggleButton),t(n),u(),g.miniViewer.scene.imageryLayers.addImageryProvider(r),g.miniViewer.camera.viewRectangle(ausExtent)},g.toggle=function(){g.expanded=!g.expanded,g.expanded?(g.container.style.width="200px",g.container.style.height="200px",g.toggleButton.className=g.toggleButton.className.replace(" minimized","")):(g.container.style.width="19px",g.container.style.height="19px",g.toggleButton.className+=" minimized")},g}]);